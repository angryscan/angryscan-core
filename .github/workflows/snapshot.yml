name: snapshot

on:
  pull_request:

permissions:
  actions: read
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.head.sha }}
  cancel-in-progress: true

jobs:
  gate_test:
    name: wait-for-test-workflow
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Wait for tests workflow to succeed for this SHA
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const headSha = context.payload.pull_request.head.sha;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const targetWorkflowName = "tests";

            const sleepMs = 15_000;
            const maxAttempts = 120; // 30 minutes

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                head_sha: headSha,
                event: "pull_request",
                per_page: 10,
              });

              const candidates = (runs.data.workflow_runs || []).filter(r => r.name === targetWorkflowName);
              const run = candidates[0];
              if (run) {
                core.info(`Found tests run: id=${run.id} status=${run.status} conclusion=${run.conclusion}`);
                if (run.status === "completed") {
                  if (run.conclusion === "success") {
                    core.info("tests succeeded; continuing snapshot workflow.");
                    return;
                  }
                  core.setFailed(`tests completed but did not succeed (conclusion=${run.conclusion}).`);
                  return;
                }
              } else {
                core.info("No tests run found yet for this SHA; waiting...");
              }

              await new Promise((resolve) => setTimeout(resolve, sleepMs));
            }

            core.setFailed("Timed out waiting for tests to complete successfully for this SHA.");

  publish_snapshot:
    name: publish-snapshot
    runs-on: ubuntu-latest
    needs: gate_test
    timeout-minutes: 30
    # Only for PRs, and never for forks (secrets exposure)
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Checkout Lib
        uses: actions/checkout@v4
        with:
          repository: packetdima/angrydata
          path: lib

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Compute snapshot version
        id: ver
        shell: bash
        run: |
          BASE_VERSION="$(./gradlew -q :kotlin-lib:printVersion | tr -d '\r' | tr -d ' ')"
          if [ -z "$BASE_VERSION" ]; then
            echo "Failed to compute base version via :kotlin-lib:printVersion" >&2
            exit 1
          fi
          SNAPSHOT_VERSION="${BASE_VERSION}-SNAPSHOT"
          echo "base_version=$BASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "snapshot_version=$SNAPSHOT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Publish SNAPSHOT to Maven Central (OSSRH)
        id: publish
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.OSSRH_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.OSSRH_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
        shell: bash
        run: |
          set -o pipefail
          if [ -z "${ORG_GRADLE_PROJECT_mavenCentralUsername:-}" ] || [ -z "${ORG_GRADLE_PROJECT_mavenCentralPassword:-}" ]; then
            echo "Missing Maven Central credentials. Configure repository secrets:"
            echo "  - OSSRH_USERNAME (or Central Portal token username)"
            echo "  - OSSRH_PASSWORD (or Central Portal token password)"
            exit 1
          fi
          if [ -z "${ORG_GRADLE_PROJECT_signingInMemoryKey:-}" ] || [ -z "${ORG_GRADLE_PROJECT_signingInMemoryKeyPassword:-}" ]; then
            echo "Missing signing key material. Configure repository secrets:"
            echo "  - SIGNING_KEY"
            echo "  - SIGNING_PASSWORD"
            exit 1
          fi
          ./gradlew --no-daemon --stacktrace -Pversion="${{ steps.ver.outputs.snapshot_version }}" :kotlin-lib:publish 2>&1 | tee publish.log

      - name: Extract published timestamp version
        id: published
        shell: bash
        run: |
          # Best-effort: try to find Maven timestamped snapshot version in Gradle output.
          # Expected format: X.Y.Z-YYYYMMDD.HHMMSS-N
          TS_VERSION="$(grep -Eo '[0-9]+\.[0-9]+\.[0-9]+-[0-9]{8}\.[0-9]{6}-[0-9]+' publish.log | head -1 || true)"
          if [ -z "$TS_VERSION" ]; then
            TS_VERSION="${{ steps.ver.outputs.snapshot_version }}"
          fi
          echo "published_version=$TS_VERSION" >> "$GITHUB_OUTPUT"

      - name: Comment PR with published version
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const version = `${{ steps.published.outputs.published_version }}`;
            const groupId = "org.angryscan";
            const artifactId = "core";
            const headSha = context.payload.pull_request.head.sha;
            const body =
              `✅ SNAPSHOT published.\n\n` +
              `**Published version:** \`${version}\`\n\n` +
              `Gradle:\n` +
              "```kotlin\n" +
              `dependencies { implementation(\"${groupId}:${artifactId}:${version}\") }\n` +
              "```\n\n" +
              `Maven:\n` +
              "```xml\n" +
              "<dependency>\n" +
              `  <groupId>${groupId}</groupId>\n` +
              `  <artifactId>${artifactId}</artifactId>\n` +
              `  <version>${version}</version>\n` +
              "</dependency>\n" +
              "```\n\n" +
              `Commit: \`${headSha}\``;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            for (const comment of comments.data) {
              if (comment.user.type === "Bot" && comment.body && comment.body.startsWith("✅ SNAPSHOT published.")) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });


